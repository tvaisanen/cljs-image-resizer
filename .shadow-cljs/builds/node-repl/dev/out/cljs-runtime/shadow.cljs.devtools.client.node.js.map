{"version":3,"sources":["shadow/cljs/devtools/client/node.cljs"],"mappings":"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","names":["p__33976","map__33977","cljs.core/--destructure-map","cljs.core.get","shadow.cljs.devtools.client.node/node-eval","js","source-map-json","msg","result","js/SHADOW_NODE_EVAL","shadow.cljs.devtools.client.node/is-loaded?","src","goog.object/get","js/SHADOW_IMPORTED","js/Error","shadow.cljs.devtools.client.node/closure-import","js/SHADOW_IMPORT","p__33978","map__33984","shadow.cljs.devtools.client.node/handle-build-complete","runtime","info","reload-info","map__33985","sources","compiled","warnings","shadow.cljs.devtools.client.env/autoload","cljs.core/empty?","shadow.cljs.devtools.client.env/ignore-warnings","files-to-require","cljs.core.remove","p__33988","map__33989","ns","cljs.core/contains?","cljs.core.filter","p__33986","map__33987","resource-id","cljs.core.map","cljs.core.into","cljs.core/seq","shadow.cljs.devtools.client.env.do_js_reload","seq__33990","chunk__33991","count__33992","i__33993","temp__5735__auto__","cljs.core/chunked-seq?","c__4591__auto__","cljs.core/chunk-first","cljs.core/chunk-rest","cljs.core/count","cljs.core/first","cljs.core/next","shadow.cljs.devtools.client.env/before-load-src","shadow.cljs.devtools.client.node/client-info","js/process.version","shadow.cljs.devtools.client.node/start","ws-url","shadow.cljs.devtools.client.env/get-ws-relay-url","socket","js/shadow.js.shim.module$ws","ws-active-ref","cljs.core.atom","data","cljs.core/deref","shadow.cljs.devtools.client.shared/remote-msg","e","shadow.cljs.devtools.client.shared/remote-open","shadow.cljs.devtools.client.shared/remote-close","shadow.cljs.devtools.client.shared/remote-error","p__33996","map__33997","shadow.cljs.devtools.client.node/send","p__34007","map__34008","shadow.cljs.devtools.client.node/stop","cljs.core/reset!","shadow.cljs.devtools.client.env/worker-client-id","cljs.core/PROTOCOL_SENTINEL","shadow.cljs.devtools.client.shared/Runtime","this","code","p__34009","map__34010","repl-sources","done","error","e34011","seq__34012","chunk__34014","count__34015","i__34016","map__34021","map__34022","output-name","p__34023","map__34024","reload-namespaces","e34025","seq__34026","chunk__34027","count__34028","i__34029","map__34048","map__34049","provides","or__4160__auto__","cljs.core/some","shadow.cljs.devtools.client.shared/add-plugin!","p__34054","map__34055","env","svc","shadow.remote.runtime.api/add-extension","shadow.cljs.devtools.client.env/patch-goog!","shadow.cljs.devtools.client.env/log","js/console.log","js/console.warn","js/console.error","shadow.cljs.devtools.client.env/run-custom-notify!","cljs.core.assoc","shadow.cljs.devtools.client.env/add-warnings-to-info","p__34058","map__34059","event-op","client-id","cljs.core._EQ_","p__34065","map__34066","shadow.remote.runtime.api/del-extension","shadow.cljs.devtools.client.shared/init-runtime!"],"sourcesContent":["(ns shadow.cljs.devtools.client.node\n  (:require\n    [\"ws\" :as ws]\n    [cljs.reader :as reader]\n    [goog.object :as gobj]\n    [shadow.remote.runtime.shared :as shared]\n    [shadow.cljs.devtools.client.shared :as cljs-shared]\n    [shadow.cljs.devtools.client.env :as env]\n    [shadow.remote.runtime.api :as api]))\n\n(defn node-eval [{:keys [js source-map-json] :as msg}]\n  (let [result (js/SHADOW_NODE_EVAL js source-map-json)]\n    result))\n\n(defn is-loaded? [src]\n  (true? (gobj/get js/SHADOW_IMPORTED src)))\n\n(defn closure-import [src]\n  {:pre [(string? src)]}\n  (js/SHADOW_IMPORT src))\n\n(defn handle-build-complete\n  [runtime {:keys [info reload-info] :as msg}]\n  (let [{:keys [sources compiled warnings]} info]\n\n    (when (and env/autoload\n               (or (empty? warnings) env/ignore-warnings))\n\n      (let [files-to-require\n            (->> sources\n                 (remove (fn [{:keys [ns]}]\n                           (contains? (:never-load reload-info) ns)))\n                 (filter (fn [{:keys [ns resource-id]}]\n                           (or (contains? compiled resource-id)\n                               (contains? (:always-load reload-info) ns))))\n                 (map :output-name)\n                 (into []))]\n\n        (when (seq files-to-require)\n          (env/do-js-reload\n            msg\n            #(doseq [src files-to-require]\n               (env/before-load-src src)\n               (closure-import src))\n            ))))))\n\n(def client-info\n  {:host :node\n   :desc (str \"Node \" js/process.version)})\n\n(defn start [runtime]\n  (let [ws-url\n        (env/get-ws-relay-url)\n\n        socket\n        (ws. ws-url #js {:rejectUnauthorized false})\n\n        ws-active-ref\n        (atom true)]\n\n    (.on socket \"message\"\n      (fn [data]\n        (when @ws-active-ref\n          (cljs-shared/remote-msg runtime data))))\n\n    (.on socket \"open\"\n      (fn [e]\n        (when @ws-active-ref\n          (cljs-shared/remote-open runtime e))))\n\n    (.on socket \"close\"\n      (fn [e]\n        (when @ws-active-ref\n          (cljs-shared/remote-close runtime e ws-url))))\n\n    (.on socket \"error\"\n      (fn [e]\n        (when @ws-active-ref\n          (cljs-shared/remote-error runtime e))))\n\n    {:socket socket\n     :ws-active-ref ws-active-ref}))\n\n(defn send [{:keys [socket]} msg]\n  (.send socket msg))\n\n(defn stop [{:keys [socket ws-active-ref]}]\n  (reset! ws-active-ref false)\n  (.close socket))\n\n;; want things to start when this ns is in :preloads\n(when (pos? env/worker-client-id)\n\n  (extend-type cljs-shared/Runtime\n    api/IEvalJS\n    (-js-eval [this code]\n      (js/SHADOW_NODE_EVAL code))\n\n    cljs-shared/IHostSpecific\n    (do-invoke [this msg]\n      (node-eval msg))\n\n    (do-repl-init [runtime {:keys [repl-sources]} done error]\n      (try\n        (doseq [{:keys [output-name] :as src} repl-sources\n                :when (not (is-loaded? output-name))]\n          (closure-import output-name))\n\n        (done)\n        (catch :default e\n          (error e))))\n\n    (do-repl-require [this {:keys [sources reload-namespaces] :as msg} done error]\n      (try\n        (doseq [{:keys [provides output-name] :as src} sources]\n          (when (or (not (is-loaded? output-name))\n                    (some reload-namespaces provides))\n            (closure-import output-name)))\n\n        (done)\n        (catch :default e\n          (error e)))))\n\n  (cljs-shared/add-plugin! ::client #{}\n    (fn [{:keys [runtime] :as env}]\n      (let [svc {:runtime runtime}]\n        (api/add-extension runtime ::client\n          {:on-welcome\n           (fn []\n             ;; FIXME: why does this break stuff when done when the namespace is loaded?\n             ;; why does it have to wait until the websocket is connected?\n             (env/patch-goog!)\n             (when env/log\n               (js/console.log (str \"shadow-cljs - #\" (-> runtime :state-ref deref :client-id) \" ready!\"))))\n\n           :on-disconnect\n           (fn []\n             (js/console.warn \"The shadow-cljs Websocket was disconnected.\"))\n\n           :ops\n           {:access-denied\n            (fn [msg]\n              (js/console.error\n                (str \"Stale Output! Your loaded JS was not produced by the running shadow-cljs instance.\"\n                     \" Is the watch for this build running?\")))\n\n            :cljs-build-configure\n            (fn [msg])\n\n            :cljs-build-start\n            (fn [msg]\n              ;; (js/console.log \"cljs-build-start\" msg)\n              (env/run-custom-notify! (assoc msg :type :build-start)))\n\n            :cljs-build-complete\n            (fn [msg]\n              ;; (js/console.log \"cljs-build-complete\" msg)\n              (let [msg (env/add-warnings-to-info msg)]\n                (handle-build-complete runtime msg)\n                (env/run-custom-notify! (assoc msg :type :build-complete))))\n\n            :cljs-build-failure\n            (fn [msg]\n              ;; (js/console.log \"cljs-build-failure\" msg)\n              (env/run-custom-notify! (assoc msg :type :build-failure)))\n\n            ::env/worker-notify\n            (fn [{:keys [event-op client-id]}]\n              (cond\n                (and (= :client-disconnect event-op)\n                     (= client-id env/worker-client-id))\n                (js/console.warn \"shadow-cljs - The watch for this build was stopped!\")\n\n                (= :client-connect event-op)\n                (js/console.warn \"shadow-cljs - A new watch for this build was started, restart of this process required!\")\n\n                :else\n                nil))\n            }})\n        svc))\n\n    (fn [{:keys [runtime] :as svc}]\n      (api/del-extension runtime ::client)))\n\n  (cljs-shared/init-runtime! client-info start send stop))\n"]}